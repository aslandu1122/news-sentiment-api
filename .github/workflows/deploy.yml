name: ğŸš€ è‡ªåŠ¨éƒ¨ç½²è‡³è…¾è®¯äº‘SCF

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ”„ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # 2. è®¾ç½®Pythonç¯å¢ƒå¹¶å®‰è£…è…¾è®¯äº‘å‘½ä»¤è¡Œå·¥å…·
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: ğŸ“¦ å®‰è£…è…¾è®¯äº‘å‘½ä»¤è¡Œå·¥å…· (tccli)
        run: pip install tccli

      # 3. é…ç½® tccli è®¤è¯ï¼ˆä½¿ç”¨GitHub Secretsï¼‰
      - name: ğŸ”‘ é…ç½® tccli è®¤è¯
        env:
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
        run: |
          # æ­£ç¡®å‘½ä»¤ï¼šä½¿ç”¨ set <key> <value> æ ¼å¼ï¼Œä¸è¦åŠ  --
          tccli configure set region ap-guangzhou  # è¯·ç¡®è®¤åœ°åŸŸ
          tccli configure set secret-id $TENCENT_SECRET_ID
          tccli configure set secret-key $TENCENT_SECRET_KEY
          set -x  # å¼€å¯è°ƒè¯•ï¼Œæ˜¾ç¤ºå®é™…æ‰§è¡Œçš„å‘½ä»¤
          tccli --version  # æŸ¥çœ‹tccliç‰ˆæœ¬
          tccli configure set secret-id "$TENCENT_SECRET_ID"
          tccli configure set secret-key "$TENCENT_SECRET_KEY"
          tccli configure set region ap-guangzhou
          set +x
          echo "è°ƒè¯•ä¿¡æ¯ç»“æŸ"
          
          # å¯é€‰ï¼šéªŒè¯é…ç½®æ˜¯å¦æˆåŠŸå†™å…¥
          echo "æ£€æŸ¥å½“å‰é…ç½®..."
          cat ~/.tccli/configure

      # 4. å°†æºä»£ç æ‰“åŒ…ä¸ºZIPæ–‡ä»¶
      - name: ğŸ“ æ‰“åŒ…æºä»£ç 
        run: |
          echo "æ­£åœ¨æ‰“åŒ…æºä»£ç ä¸ºZIPæ–‡ä»¶..."
          # å‹ç¼©å½“å‰ç›®å½•ï¼Œæ’é™¤Gitå’ŒGitHub Actionsç›¸å…³æ–‡ä»¶
          zip -r code.zip . -x '*.git*' '*.github/*' '.DS_Store'
          echo "æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -lh code.zip

      # 5. è°ƒç”¨APIæ›´æ–°äº‘å‡½æ•°ä»£ç 
      - name: â¬†ï¸ æ›´æ–°äº‘å‡½æ•°ä»£ç 
        run: |
          echo "æ­£åœ¨å°†ä»£ç åŒ…ä¸Šä¼ å¹¶æ›´æ–°äº‘å‡½æ•°..."
          # è¯·å°† `YOUR_ACTUAL_FUNCTION_NAME` æ›¿æ¢ä¸ºæ‚¨çš„å®é™…å‡½æ•°å
          tccli scf UpdateFunctionCode --FunctionName news-sentiment-analyzer --ZipFile fileb://code.zip
          echo "âœ… äº‘å‡½æ•°ä»£ç æ›´æ–°æŒ‡ä»¤å·²å‘é€ã€‚"

      # 6. è¾“å‡ºæˆåŠŸä¿¡æ¯
      - name: ğŸ‰ éƒ¨ç½²å®Œæˆ
        run: |
          echo "========================================"
          echo "ğŸš€ GitHub Actions å·¥ä½œæµæ‰§è¡Œå®Œæ¯•ï¼"
          echo "ç†è®ºä¸Šï¼Œæ‚¨çš„ä»£ç å·²éƒ¨ç½²è‡³è…¾è®¯äº‘äº‘å‡½æ•°ã€‚"
          echo "æç¤ºï¼šè¯·ç™»å½•è…¾è®¯äº‘SCFæ§åˆ¶å°ï¼Œç¡®è®¤å‡½æ•°ä»£ç å·²æ›´æ–°ï¼Œå¹¶æ£€æŸ¥å‡½æ•°URLæ˜¯å¦å¯ä»¥æ­£å¸¸è°ƒç”¨ã€‚"
          echo "========================================"
