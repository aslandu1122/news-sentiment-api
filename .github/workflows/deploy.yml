name: ğŸš€ ä½¿ç”¨ Python SDK éƒ¨ç½²è‡³è…¾è®¯äº‘ SCF

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: ğŸ“¦ å®‰è£…ä¾èµ– (è…¾è®¯äº‘ SDK)
        run: pip install tencentcloud-sdk-python

      - name: ğŸ“ åˆ›å»ºéƒ¨ç½²åŒ…
        run: |
          # åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„ä¸´æ—¶ç›®å½•ï¼Œåªæ”¾å…¥è¿è¡Œæ‰€éœ€çš„æ–‡ä»¶
          mkdir -p deploy_pkg
          cp sentiment_analysis.py requirements.txt deploy_pkg/
          cd deploy_pkg
          zip -r ../function.zip ./*
          cd ..
          echo "éƒ¨ç½²åŒ… function.zip å·²åˆ›å»ºï¼ŒåŒ…å«æ–‡ä»¶ï¼š"
          unzip -l function.zip

      - name: â¬†ï¸ ä½¿ç”¨ Python SDK æ›´æ–°äº‘å‡½æ•°
        env:
          # ç›´æ¥ä» GitHub Secrets è¯»å–ï¼Œå®‰å…¨ä¸”å·²éªŒè¯æœ‰æ•ˆ
          TENCENT_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TENCENT_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}
        run: |
          python -c "
import os, json, base64
from tencentcloud.common import credential
from tencentcloud.common.profile.client_profile import ClientProfile
from tencentcloud.common.profile.http_profile import HttpProfile
from tencentcloud.scf.v20180416 import scf_client, models

# 1. è®¤è¯ï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
cred = credential.Credential(os.environ['TENCENT_SECRET_ID'], os.environ['TENCENT_SECRET_KEY'])

# 2. åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼ˆè¯·å°† REGION æ›¿æ¢ä¸ºä½ çš„å‡½æ•°åœ°åŸŸï¼Œä¾‹å¦‚ ap-shanghaiï¼‰
REGION = 'ap-guangzhou'  # TODO: é‡è¦ï¼è¯·ä¿®æ”¹ä¸ºä½ çš„å‡½æ•°åœ°åŸŸ
httpProfile = HttpProfile()
httpProfile.endpoint = 'scf.tencentcloudapi.com'
clientProfile = ClientProfile()
clientProfile.httpProfile = httpProfile
client = scf_client.ScfClient(cred, REGION, clientProfile)

# 3. è¯»å–å¹¶ç¼–ç éƒ¨ç½²åŒ…
with open('function.zip', 'rb') as f:
    zip_file = base64.b64encode(f.read()).decode('utf-8')

# 4. æ„å»ºæ›´æ–°è¯·æ±‚
req = models.UpdateFunctionCodeRequest()
# TODO: é‡è¦ï¼è¯·ç¡®ä¿å‡½æ•°åä¸æ§åˆ¶å°å®Œå…¨ä¸€è‡´
req.FunctionName = 'news-sentiment-analyzer'  
req.ZipFile = zip_file

# 5. å‘é€è¯·æ±‚
try:
    resp = client.UpdateFunctionCode(req)
    print('ğŸ‰ å‡½æ•°ä»£ç æ›´æ–°æˆåŠŸï¼')
    print('è¯·æ±‚ID:', resp.RequestId)
except Exception as e:
    print('âŒ æ›´æ–°å¤±è´¥:', e)
    exit(1)
          "
